{% extends 'mm08/base.html' %}
{% block title %}
  Теплокарты MOEX
{% endblock %}

{% block content %}
  <div class="mm-card">
    <div class="mm-heatbar">
      <h2 style="margin:0;">Теплокарты MOEX</h2>

      <form method="post" action="{% url 'mm08:heatmap_refresh' %}" class="controls">
        {% csrf_token %}
        <select name="board" id="board-select" class="select">…</select>
        <input type="date" name="date" value="{{ date }}" class="date" />
        <input type="hidden" name="redirect" value="1" />

        <button type="submit" name="label" value="fast" class="mm-btn">Обновить (fast)</button>
        <button type="submit" name="label" value="fresh" class="mm-btn">Обновить (fresh)</button>
      </form>

      <a class="mm-btn ghost" href="/heatmaps/?board={{ board|default:'TQBR' }}">Снимок из БД (последний)</a>
      <a class="mm-btn ghost" href="/heatmaps/export.csv?board={{ board|default:'TQBR' }}">Экспорт CSV</a>
    </div>

    {# Информация о текущем срезе: дата (snapshot.date) + время сохранения (created_at time) #}
    <div style="margin-top:10px; color:#4b5563;">
      {% if snapshot %}
        Срез: {{ snapshot.board }}
        — {{ snapshot.label|default:'' }}
        — {{ snapshot.date|date:'d.m.Y' }} {{ snapshot.created_at|time:'H:i' }}
      {% else %}
        Срез не найден.
      {% endif %}
    </div>

    {# Сетка плиток #}
    <div class="heat-grid">
      {% for t in tiles %}
        <div class="heat-tile" style="background: {{ t.bg }}">
          <div class="heat-ticker">{{ t.ticker }}</div>
          <div class="heat-short">{{ t.shortname|default:'' }}</div>

          <div class="heat-last">
            {% if t.last %}
              {{ t.last|floatformat:2 }}
            {% else %}
              —
            {% endif %}
          </div>

          <div class="heat-change">
            {% if t.change_pct is not None %}
              {{ t.change_pct|floatformat:2 }}%
            {% else %}
              —%
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p>Нет данных. Нажмите «Обновить» или выберите другую дату/борд.</p>
      {% endfor %}
    </div>

    {# Переключатель "Показать по: N / стр" — сохраняем текущий label #}
    <details class="mm-acc">
      <summary class="mm-btn ghost">Показать по: {{ per }} / стр</summary>
      <div class="mm-acc-panel">
        {% for n in per_choices %}
          <a class="mm-btn ghost" href="?board={{ board }}&label={% firstof snapshot.label request.GET.label '' %}&per={{ n }}" style="margin-right:6px; margin-top:6px;{% if n == per %} pointer-events:none; opacity:.65;{% endif %}">{{ n }}</a>
        {% endfor %}
      </div>
    </details>

    {# Пагинация (окно из 5 страниц) — сохраняем label и per #}
    {% if paginator.num_pages > 1 %}
      <div class="mm-pager-wrap">
        {# First #}
        {% if page_obj.has_previous %}
          <a class="mm-page" href="?board={{ board }}&label={% firstof snapshot.label request.GET.label '' %}&per={{ per }}&page=1">First</a>
        {% else %}
          <span class="mm-page disabled">First</span>
        {% endif %}

        {# Prev #}
        {% if page_obj.has_previous %}
          <a class="mm-page" href="?board={{ board }}&label={% firstof snapshot.label request.GET.label '' %}&per={{ per }}&page={{ page_obj.previous_page_number }}">‹</a>
        {% else %}
          <span class="mm-page disabled">‹</span>
        {% endif %}

        {# Window (числовые кнопки) #}
        {% for n in page_numbers %}
          {% if n == page_obj.number %}
            <span class="mm-page current">{{ n }}</span>
          {% else %}
            <a class="mm-page" href="?board={{ board }}&label={% firstof snapshot.label request.GET.label '' %}&per={{ per }}&page={{ n }}">{{ n }}</a>
          {% endif %}
        {% endfor %}

        {# Next #}
        {% if page_obj.has_next %}
          <a class="mm-page" href="?board={{ board }}&label={% firstof snapshot.label request.GET.label '' %}&per={{ per }}&page={{ page_obj.next_page_number }}">›</a>
        {% else %}
          <span class="mm-page disabled">›</span>
        {% endif %}

        {# Last #}
        {% if page_obj.has_next %}
          <a class="mm-page" href="?board={{ board }}&label={% firstof snapshot.label request.GET.label '' %}&per={{ per }}&page={{ paginator.num_pages }}">Last</a>
        {% else %}
          <span class="mm-page disabled">Last</span>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}
